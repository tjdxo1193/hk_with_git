<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lims.api.mt.dao.MonitorTestRequestDao">

    <select id="getMonitorTestRequestList" parameterType="MonitorTestRequestVO" resultType="MonitorTestRequestVO">
        SELECT MMAP.PLNT_CD
            , MMAP.MITM_REQ_IDX
            , MMAP.MITM_SPEC_IDX
            , (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = MMAP.ANS_PROC_CD) AS ANS_PROC_NM
            , MMAP.REQ_NO
            , MMAP.REQ_DT
            , MMAP.ANS_EDT
            , MMAP.REQ_DS
            , (SELECT DPT_NM FROM SY_DPT SD WHERE SD.DPT_CD = MMAP.REQ_DPT_CD) AS REQ_DPT_NM
            , MM.MITM_CD
            , (SELECT TREE_NM FROM SY_CD_TREE SCT WHERE SCT.TREE_CD = MM.MITM_CD) AS MITM_NM
            , (SELECT TREE_NM FROM SY_CD_TREE SCT WHERE SCT.TREE_CD = MM.MITM_WRK_PLC_DIV) AS MITM_WRK_PLC_DIV_NM
            , (SELECT TREE_NM FROM SY_CD_TREE SCT WHERE SCT.TREE_CD = MM.MITM_PITM_DIV) AS MITM_PITM_DIV_NM
            , MM.POINT
            , MM.ROOMNO
            , MM.GRADE
            , (SELECT DPT_NM FROM SY_DPT SD WHERE SD.DPT_CD = MM.CRG_DPT_CD AND SD.PLNT_CD = MMAP.PLNT_CD) AS CRG_DPT_NM
            , (SELECT ANS_CYL_RULE_NM FROM SY_ANS_CYL SAC WHERE SAC.ANS_CYL_CD = MM.ANS_CYL_CD) AS ANS_CYL_RULE_NM
        FROM MT_MITM_ANS_PROC MMAP
        LEFT JOIN MM_MITM_SPEC MMS ON MMAP.MITM_SPEC_IDX = MMS.MITM_SPEC_IDX AND MMAP.PLNT_CD = MMS.PLNT_CD
        LEFT JOIN MM_MITM MM ON MMS.PLNT_CD = MM.PLNT_CD AND MMS.MITM_CD = MM.MITM_CD
        WHERE 1=1
        AND MMAP.PLNT_CD = #{plntCd}
        AND MMAP.ANS_PROC_CD = #{ansProcCd}
        AND REQ_CANL_YN = 'N'
        <if test="mitmNm != null and mitmNm != ''">
            AND (SELECT UPPER(TREE_NM) FROM SY_CD_TREE SCT WHERE SCT.TREE_CD = MM.MITM_CD) LIKE ('%' || TRIM(UPPER(#{mitmNm})) || '%')
        </if>
    </select>

    <update id="request" parameterType="MonitorTestRequestVO">
        <selectKey resultType="string" keyProperty="reqNo" order="BEFORE">
            SELECT 'MQ' || TO_CHAR(SYSDATE, 'YYMM') || LPAD(NVL(MAX(SUBSTR(ANS_NO, -4))+1,1),4,0) FROM MT_MITM_ANS_PROC WHERE PLNT_CD = #{plntCd}
        </selectKey>
        UPDATE MT_MITM_ANS_PROC SET
            ANS_PROC_CD = #{ansProcCd}
            , REQ_NO = #{reqNo}
            , REQ_DT = TO_CHAR(SYSDATE, 'YYYY-MM-DD')
            , REQ_DS = SYSDATE
            , REQ_DPT_CD = #{reqDptCd}
            , REQ_UID = #{reqUid}
            , REQ_RMK = #{reqRmk}
            , REQ_CANL_YN = 'N'
        WHERE MITM_REQ_IDX = #{mitmReqIdx}
        AND PLNT_CD = #{plntCd}
    </update>

    <update id="requestCancel" parameterType="MonitorTestRequestVO">
        UPDATE MT_MITM_ANS_PROC SET
            , REQ_CANL_DS = SYSDATE
            , REQ_CANL_UID = #{reqCanlUid}
            , REQ_CANL_REA = #{reqCanlRea}
            , REQ_CANL_YN = 'Y'
        WHERE MITM_REQ_IDX = #{mitmReqIdx}
        AND PLNT_CD = #{plntCd}
    </update>

</mapper>