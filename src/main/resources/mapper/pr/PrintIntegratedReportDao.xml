<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lims.api.pr.dao.PrintIntegratedReportDao">
    <select id="find" parameterType="PrintIntegratedReportVO" resultType="PrintIntegratedReportVO">
        SELECT QPAR.PLNT_CD,
               QPAR.REQ_IDX,
               QPAR.ISP_REQ_NO,
               QPAR.ISP_REQ_DT,
               QPAR.MTR_CD,
               QPAR.MTR_NM,
               QPAR.BATCH_NO,
               QPAR.ETR_QTY,
               QPAR.INP_UNIT,
               QPAR.ETR_DT,
               QPAR.SPL_CD,
               QPAR.SPL_NM,
               QPAR.LOT_NO,
               QPAR.SPL_LOT_NO,
               QPAR.MAK_DT,
               QPAR.CSM_NM,
               QPAR.UDT_DS,
               QPAR.REV_DS,
               QP.PITM_CD,
               QPI.PITM_NM,
               QPI.PITM_EN,
               (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPI.PITM_TYP) AS PITM_TYP_NM,
               QP.PITM_VER,
               QPAP.ANS_IDX,
               QPAP.ANS_NO,
               QPAP.OOS_YN,
               QPAP.SYT_JDG,
               (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPAP.SYT_JDG) AS SYT_JDG_NM,
               QPAP.REQ_DT,
               QPAP.RCP_DT,
               QPAP.RCP_UID,
               (SELECT USER_NM FROM SY_USER SU
               WHERE SU.USER_ID = QPAP.RCP_UID
                 AND SU.PLNT_CD = QPAP.PLNT_CD) AS RCP_UNM,
               DECODE(QPAP.CLLT_DT, NULL, SYSDATE, QPAP.CLLT_DT) AS CLLT_DT,
               QPAP.CLLT_UID,
               (SELECT USER_NM FROM SY_USER SU
               WHERE SU.USER_ID = QPAP.CLLT_UID
                 AND SU.PLNT_CD = QPAP.PLNT_CD) AS CLLT_UNM,
               QPAI.SMP_STRG_MTD,
               QPAI.SMP_VOL_UNIT,
               (NVL(QPAI.SMP_VOL_ANS, 0) + NVL(QPAI.SMP_VOL_ETC, 0) + NVL(QPAI.SMP_VOL_STRG, 0)) AS SMP_VOL_TOT,
               QPAI.PKG_MTR_SPEC,
               QPAI.RMTR_SPEC,
               QPAI.RMTR_CFMUL,
               QPAI.RPT_SPCC,
               QPAI.ARPT_SPCC
        FROM QT_PITM_ANS_REQ QPAR
            LEFT JOIN QT_PITM_ANS_PROC QPAP ON QPAR.REQ_IDX = QPAP.REQ_IDX AND QPAR.PLNT_CD = QPAP.PLNT_CD
            LEFT JOIN QT_PITM_ANS_INFO QPAI ON QPAP.ANS_IDX = QPAI.ANS_IDX AND QPAP.PLNT_CD = QPAI.PLNT_CD
            LEFT JOIN QM_PITM_SPEC QPS ON QPAP.PITM_SPEC_IDX = QPS.PITM_SPEC_IDX
                                              AND QPAR.MTR_CD = QPS.PITM_CD AND QPAP.PLNT_CD = QPS.PLNT_CD
            LEFT JOIN QM_PITM QP ON QPS.PITM_CD = QP.PITM_CD
                                        AND QPS.PITM_VER = QP.PITM_VER AND QPS.PLNT_CD = QP.PLNT_CD
            LEFT JOIN QM_PITM_INFO QPI ON QP.PITM_CD = QPI.PITM_CD
                                              AND QP.PITM_VER  = QPI.PITM_VER AND QP.PLNT_CD = QPI.PLNT_CD
            LEFT JOIN QM_PITM_INFO_SAP QPIS ON QP.PITM_CD = QPIS.PITM_CD
                                                   AND QP.PITM_VER = QPIS.PITM_VER AND QP.PLNT_CD = QPIS.PLNT_CD
        WHERE QPAR.PLNT_CD = #{plntCd}
          AND QPAP.ANS_PROC_CD = 'S0130900'
          AND QPAP.HLD_YN = 'N'
          AND QPI.PITM_TYP IN ('S0180100', 'S0180101')
          AND QPAI.ANS_IDX IS NOT NULL
          <if test="sytJdg != null and sytJdg != ''">
          AND QPAP.SYT_JDG = #{sytJdg}
          </if>
          <if test="ansProcCd != null and ansProcCd != ''">
          AND QPAP.ANS_PROC_CD = #{ansProcCd}
          </if>
          <if test="pitmTyp != null and pitmTyp != ''">
          AND QPI.PITM_TYP = #{pitmTyp}
          </if>
          <if test="pitmNm != null and pitmNm != ''">
          AND TRIM(UPPER(QPI.PITM_NM)) LIKE ('%' || TRIM(UPPER(#{pitmNm})) || '%')
          </if>
          <if test="pitmCd != null and pitmCd != ''">
          AND TRIM(UPPER(QPI.PITM_CD)) LIKE ('%' || TRIM(UPPER(#{pitmCd})) || '%')
          </if>
          <if test="lotNo != null and lotNo != ''">
          AND TRIM(UPPER(QPAR.LOT_NO)) LIKE ('%' || TRIM(UPPER(#{lotNo})) || '%')
          </if>
          <if test="batchNo != null and batchNo != ''">
          AND TRIM(UPPER(QPAR.BATCH_NO)) LIKE ('%' || TRIM(UPPER(#{batchNo})) || '%')
          </if>
          <if test="ansNo != null and ansNo != ''">
          AND TRIM(UPPER(QPAP.ANS_NO)) LIKE ('%' || TRIM(UPPER(#{ansNo})) || '%')
          </if>
          <if test="ispReqNo != null and ispReqNo != ''">
            AND TRIM(UPPER(QPAR.ISP_REQ_NO)) LIKE ('%' || TRIM(UPPER(#{ispReqNo})) || '%')
          </if>
            <if test="searchReqDt != null and searchReqDt != ''">
                AND QPAP.REQ_DT BETWEEN #{searchReqDt[0]} AND #{searchReqDt[1]}
            </if>
        ORDER BY QPAR.REQ_IDX
    </select>

    <select id="findTestItem" parameterType="PrintIntegratedReportVO" resultType="PrintIntegratedReportVO">
        SELECT QPAR.PLNT_CD
            , QPAR.ANS_IDX
            , QPAR.RST_SEQ
            , QPAR.RST_PROC_CD
            , (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPAR.RST_PROC_CD) AS RST_PROC_NM
            , QPAR.ANS_UID
            , (SELECT USER_NM FROM SY_USER WHERE USER_ID = QPAR.ANS_UID AND PLNT_CD = QPAR.PLNT_CD) AS ANS_UNM
            , QPAR.ISP_DUR_TM
            , QPAR.EQM_USE_TM
            , QPAR.ANS_EQM_CD
            , QPAR.AMITM_CD
            , MA.VRIA_KN
            , MA.VRIA_NO
            , (SELECT AITM_KN FROM MS_AITM WHERE AITM_CD = MA.AITM_CD) AS AITM_KN
            , QPAR.RST_JDG
            , (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPAR.RST_JDG) AS RST_JDG_NM
            , QPAR.RST_RMK
            , QPAR.ANS_EQM_CD
            , QPAR.PERSPEC_TXT
            , QPAR.OWC_SPEC_TXT
            , QPAR.SPEC_TXT_EN
            , QPAR.PER_SLV_LOW
            , QPAR.PER_SLV_UPP
            , QPAR.PER_SLV_DESC
            , QPAR.OWC_SLV_LOW
            , QPAR.OWC_SLV_UPP
            , QPAR.OWC_SLV_DESC
            , QPAR.RST_DPNT
            , QPAR.RPT_PRT_SLV_VAL
            , QPAR.RPT_PRT_ITM_NM
            , (DECODE(SUBSTR(QPAR.RST_VAL, 0, 4), 'U008', (SELECT DTL_NM FROM SY_CD_DTL WHERE DTL_CD = QPAR.RST_VAL AND PLNT_CD = QPAR.PLNT_CD), RST_VAL)) AS RST_VAL
            , QPAR.MARK_VAL
            , QPAR.ANS_RST_INP_DS
            , QPAR.RPT_PRT_YN
            , ANS_DPT_CD
            , (SELECT DPT_NM FROM SY_DPT SD WHERE SD.DPT_CD = QPAR.ANS_DPT_CD AND SD.PLNT_CD = QPAR.PLNT_CD) AS ANS_DPT_NM
            , QPAR.SPEC_TYP
            , (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPAR.SPEC_TYP) AS SPEC_TYP_NM
            , QPAR.JDG_TYP
            , (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPAR.JDG_TYP) AS JDG_TYP_NM
            , QPAR.SLV_JDG_CFM
            , (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPAR.SLV_JDG_CFM AND SCD.PLNT_CD = QPAR.PLNT_CD) AS SLV_JDG_CFM_NM
            , QPAR.SLV_JDG_NON_CFM
            , (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPAR.SLV_JDG_NON_CFM AND SCD.PLNT_CD = QPAR.PLNT_CD) AS SLV_JDG_NON_CFM_NM
            , QPAR.RST_UNIT_CD
            , (SELECT DTL_NM FROM SY_CD_DTL SCD WHERE SCD.DTL_CD = QPAR.RST_UNIT_CD AND SCD.PLNT_CD = QPAR.PLNT_CD) AS RST_UNIT_NM
            , QPAR.RST_FILE_IDX AS FILE_IDX
            , ((SELECT COUNT(FILE_SRLNO) FROM SY_FILE_INFO WHERE FILE_IDX = QPAR.RST_FILE_IDX AND DEL_YN = 'N' AND PLNT_CD = QPAR.PLNT_CD) || 'ê±´') AS FILE_CNT
            , QPAR.MKR_QTY
            , QPAR.AITM_RMK
            , QPAP.ANS_NO
            , QPI.PITM_TYP
            , (SELECT DTL_NM FROM SY_CD_DTL WHERE DTL_CD = QPI.PITM_TYP) AS PITM_TYP_NM
            , QPI.PITM_CD
            , QPI.PITM_NM
        FROM QT_PITM_ANS_RST QPAR
        LEFT JOIN MS_AMITM MA ON MA.AMITM_CD = QPAR.AMITM_CD
        LEFT JOIN QT_PITM_ANS_PROC QPAP ON QPAR.PLNT_CD = QPAP.PLNT_CD AND QPAR.ANS_IDX = QPAP.ANS_IDX
        LEFT JOIN QM_PITM_SPEC QPS ON QPAP.PLNT_CD = QPS.PLNT_CD AND QPAP.PITM_SPEC_IDX = QPS.PITM_SPEC_IDX
        LEFT JOIN QM_PITM QP ON QPS.PLNT_CD = QP.PLNT_CD AND QPS.PITM_CD = QP.PITM_CD AND QPS.PITM_VER = QP.PITM_VER
        LEFT JOIN QM_PITM_INFO QPI ON QP.PLNT_CD = QPI.PLNT_CD AND QP.PITM_CD = QPI.PITM_CD AND QP.PITM_VER = QPI.PITM_VER
        WHERE QPAR.PLNT_CD = #{plntCd}
        AND QPAR.ANS_IDX = #{ansIdx}
        AND QPAR.DEL_YN = 'N'
        ORDER BY QPAR.AITM_ORD
    </select>

    <select id="findReportHistory" parameterType="PrintIntegratedReportVO" resultType="PrintIntegratedReportVO">
        SELECT QPAA.PLNT_CD,
            QPAA.ANS_IDX,
            QPAA.ARPT_SEQ,
            QPAA.ARPT_RPT_IDX,
            QPAA.ARPT_SPCC,
            QPAA.SHIPT_DT,
            QPAA.SHIPT_QTY,
            QPAA.WRT_UID,
            (SELECT USER_NM FROM SY_USER WHERE PLNT_CD = QPAA.PLNT_CD AND USER_ID = QPAA.WRT_UID) AS WRT_NM,
            QPAA.WRT_DS,
            QPAA.PRT_UID,
            (SELECT USER_NM FROM SY_USER WHERE PLNT_CD = QPAA.PLNT_CD AND USER_ID = QPAA.PRT_UID) AS PRT_NM,
            QPAA.PRT_DS,
            QPAA.DEL_YN,
            QPAR.MTR_CD,
            QPAR.BATCH_NO,
            SRM.RPT_RD_PATH
        FROM QT_PITM_ANS_ARPT QPAA
        LEFT JOIN QT_PITM_ANS_PROC QPAP ON QPAA.ANS_IDX = QPAP.ANS_IDX AND QPAA.PLNT_CD = QPAP.PLNT_CD
        LEFT JOIN QT_PITM_ANS_REQ QPAR ON QPAP.REQ_IDX = QPAR.REQ_IDX
        LEFT JOIN SY_RPT_MST SRM ON QPAA.ARPT_RPT_IDX = SRM.RPT_IDX
        WHERE QPAA.PLNT_CD = #{plntCd}
        AND QPAA.ANS_IDX  = #{ansIdx}
        ORDER BY ARPT_SEQ
    </select>

    <insert id="create" parameterType="PrintIntegratedReportVO">
        <selectKey resultType="Integer" order="BEFORE"  keyProperty="arptSeq">
            SELECT NVL(MAX(QPAA.ARPT_SEQ) + 1, 1) AS ARPT_SEQ
            FROM QT_PITM_ANS_ARPT QPAA
            WHERE QPAA.ANS_IDX = #{ansIdx}
        </selectKey>
        INSERT INTO QT_PITM_ANS_ARPT (
            PLNT_CD,
            ANS_IDX,
            ARPT_SEQ,
            ARPT_RPT_IDX,
            SHIPT_DT,
            SHIPT_QTY,
            ARPT_SPCC,
            WRT_DS,
            WRT_UID,
            DEL_YN
        ) VALUES (
            #{plntCd}
            , #{ansIdx}
            , #{arptSeq}
            , #{arptRptIdx}
            , #{shiptDt}
            , #{shiptQty}
            , #{arptSpcc}
            , SYSDATE
            , #{wrtUid}
            , #{delYn}
        )
    </insert>

    <update id="update" parameterType="PrintIntegratedReportVO">
        UPDATE QT_PITM_ANS_ARPT SET
            ARPT_RPT_IDX = #{arptRptIdx}
            , SHIPT_DT = #{shiptDt}
            , SHIPT_QTY = #{shiptQty}
            , ARPT_SPCC = #{arptSpcc}
            , DEL_YN = #{delYn}
        WHERE ANS_IDX = #{ansIdx}
        AND PLNT_CD = #{plntCd}
        AND ARPT_SEQ = #{arptSeq}
    </update>

    <select id="findReportDetail" parameterType="PrintIntegratedReportVO" resultType="PrintIntegratedReportVO">
        SELECT SRM.RPT_IDX,
               SRM.RPT_DIV,
               (SELECT DTL_NM FROM SY_CD_DTL WHERE DTL_CD = SRM.RPT_DIV) AS RPT_DIV_NM,
               SRM.RPT_NM,
               SRM.RPT_RD_PATH,
               SRM.RPT_RMK AS ARPT_SPCC,
               SRM.ETC_RMK
        FROM SY_RPT_MST SRM
        WHERE SRM.RPT_DIV = 'S0240002'
            AND SRM.RPT_IDX = #{rptIdx}
        ORDER BY RPT_NM
    </select>
</mapper>